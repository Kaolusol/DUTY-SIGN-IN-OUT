<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบลงชื่อปฏิบัติหน้าที่ | สถานีดับเพลิง BIT Cities</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script>
        // === Firebase Configuration (ใช้จากที่คุณให้มา) ===
        const firebaseConfig = {
          apiKey: "AIzaSyA_Zvo1O9gazY3lc8oU1Zg4Q-GPwCQenYM",
          authDomain: "duty-sign-inout.firebaseapp.com",
          projectId: "duty-sign-inout",
          storageBucket: "duty-sign-inout.firebasestorage.app",
          messagingSenderId: "1091884542325",
          appId: "1:1091884542325:web:62cd115b5c9e63fa844b3c",
          databaseURL: "https://duty-sign-inout-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // เริ่มต้น Firebase App
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(app);
        
        // กำหนด Path หลักใน Firebase
        const LOG_PATH = 'duty_logs';
        const STATUS_PATH = 'duty_status';

        console.log("Firebase App และ Realtime Database ถูกตั้งค่าเรียบร้อยแล้ว!");
    </script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        h1 { color: #cc0000; margin-bottom: 5px; }
        h2 { color: #555; margin-top: 0; font-weight: normal; font-size: 1.2em; margin-bottom: 25px; }
        .form-group { text-align: left; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], select#unitSelect {
            width: 95%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; box-sizing: border-box;
        }
        select#unitSelect {
            width: 100%; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: white;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13%205.1L146.2%20202.7%2018.8%2074.5a17.6%2017.6%200%200%200-25.3%200%2017.6%2017.6%200%200%200%200%2025.3l137%20137a17.6%2017.6%200%200%200%2025.3%200l137-137a17.6%2017.6%200%200%200%200-25.3%2017.6%2017.6%200%200%200-12.8-5.1z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: right 10px top 50%; background-size: 10px auto;
        }
        .button-group { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; margin-bottom: 30px; }
        .duty-button { flex-grow: 1; padding: 15px; border: none; border-radius: 6px; color: white; font-size: 1.1em; cursor: pointer; transition: background-color 0.3s; font-weight: bold; }
        .sign-in { background-color: #28a745; }
        .sign-in:hover { background-color: #218838; }
        .sign-out { background-color: #dc3545; }
        .sign-out:hover { background-color: #c82333; }
        .log-area { margin-top: 20px; padding: 15px; background-color: #eee; border-radius: 4px; text-align: left; }
        .log-area h3 { margin-top: 0; color: #333; }
        #dutyLog { list-style: none; padding: 0; }
        #dutyLog li { padding: 5px 0; border-bottom: 1px dotted #ccc; font-size: 0.9em; }
        #dutyLog li:last-child { border-bottom: none; }
    </style>
</head>
<body onload="listenForLogs()">
    <div class="container">
        <h1>ระบบลงชื่อปฏิบัติหน้าที่</h1>
        <h2>สถานีดับเพลิงและกู้ภัย BIT Cities</h2>
        
        <div class="form-group">
            <label for="firefighterID">รหัสเจ้าหน้าที่:</label>
            <input type="text" id="firefighterID" name="firefighterID" placeholder="ป้อนรหัส เช่น FR-001" required>
        </div>

        <div class="form-group">
            <label for="unitSelect">เลือกหน่วยปฏิบัติหน้าที่:</label>
            <select id="unitSelect" name="unitSelect" required>
                <option value="" disabled selected>-- กรุณาเลือกหน่วย --</option>
                <option value="EMERGENCY MEDICAL TECHNICIAN (EMT)">EMERGENCY MEDICAL TECHNICIAN (EMT)</option>
                <option value="ATV LANCE TEAM (ATL)">ATV LANCE TEAM (ATL)</option>
                <option value="ปภ. (DDPM)">ปภ. (DDPM)</option>
                <option value="ดับเพลิง/กู้ภัยดับเพลิง (BFRD)">ดับเพลิง/กู้ภัยดับเพลิง (BFRD)</option>
            </select>
        </div>
        
        <div class="button-group">
            <button class="duty-button sign-in" onclick="logAction('SIGN_IN')">ขึ้นเวร (Sign In)</button>
            <button class="duty-button sign-out" onclick="logAction('SIGN_OUT')">ลงเวร (Sign Out)</button>
        </div>

        <div class="log-area">
            <h3>บันทึกการปฏิบัติหน้าที่ล่าสุด (ดึงจาก Firebase)</h3>
            <ul id="dutyLog">
                </ul>
        </div>
    </div>
    
    <script>
        /**
         * ดึงสถานะปัจจุบันของเจ้าหน้าที่จาก Firebase
         * @param {string} id รหัสเจ้าหน้าที่
         * @returns {object} {onDuty: boolean, onDutyUnit: string | null}
         */
        async function getDutyStatus(id) {
            try {
                const snapshot = await database.ref(`${STATUS_PATH}/${id}`).once('value');
                const val = snapshot.val();
                return {
                    onDuty: val ? val.onDuty : false,
                    onDutyUnit: val ? val.onDutyUnit : null // หน่วยที่ใช้ขึ้นเวรล่าสุด
                };
            } catch (error) {
                console.error("Error reading status:", error);
                alert("เกิดข้อผิดพลาดในการตรวจสอบสถานะ");
                return { onDuty: true, onDutyUnit: null }; // ป้องกันการลงชื่อซ้ำหากเกิด error
            }
        }

        // ฟังก์ชันบันทึก Log และอัปเดตสถานะใน Firebase
        async function logAction(actionType) {
            const id = document.getElementById('firefighterID').value.toUpperCase().trim();
            const unit = document.getElementById('unitSelect').value;

            // 1. ตรวจสอบข้อมูลพื้นฐาน
            if (!unit) {
                alert('กรุณาเลือกหน่วยปฏิบัติหน้าที่!');
                return;
            }
            const idPattern = /^[A-Z]{2,3}-\d{2,3}$/;
            if (!idPattern.test(id)) {
                alert('รหัสเจ้าหน้าที่ไม่ถูกต้อง! รหัสต้องเป็น ENG 2-3 ตัว - เลข 2-3 หลัก (เช่น FR-12, EMT-050)');
                return;
            }

            // 2. ตรวจสอบสถานะและเงื่อนไข Unit Lock
            const status = await getDutyStatus(id);

            if (actionType === 'SIGN_IN') {
                if (status.onDuty) {
                    alert('ไม่สามารถขึ้นเวรซ้ำได้! เจ้าหน้าที่คนนี้ยังอยู่ในสถานะ "ขึ้นเวร"');
                    return;
                }
            } else if (actionType === 'SIGN_OUT') {
                if (!status.onDuty) {
                    alert('ไม่สามารถลงเวรได้! เจ้าหน้าที่คนนี้ยังไม่ได้อยู่ในสถานะ "ขึ้นเวร"');
                    return;
                }
                // *** เงื่อนไขการล็อคหน่วย ***
                if (status.onDutyUnit && status.onDutyUnit !== unit) {
                    alert(`ลงเวรไม่สำเร็จ! คุณต้องลงเวรในหน่วยที่คุณขึ้นมา: ${status.onDutyUnit}`);
                    return;
                }
            }

            // 3. เตรียมข้อมูล
            const timestamp = Date.now();
            const logEntry = {
                id: id,
                unit: unit,
                action: actionType, 
                timestamp: timestamp
            };

            const newStatus = {
                id: id,
                unit: unit,
                onDuty: actionType === 'SIGN_IN',
                lastAction: actionType,
                lastTimestamp: timestamp
            };
            
            // เพิ่ม Unit ที่ใช้ขึ้นเวรล่าสุดเพื่อใช้ในการล็อค
            if (actionType === 'SIGN_IN') {
                newStatus.onDutyUnit = unit;
            } else {
                newStatus.onDutyUnit = null; // ล้างเมื่อลงเวรสำเร็จ
            }
            
            // 4. บันทึก/อัปเดตข้อมูลใน Firebase (Transaction)
            try {
                // บันทึก Log ใหม่
                await database.ref(LOG_PATH).push(logEntry);

                // อัปเดตสถานะ
                await database.ref(`${STATUS_PATH}/${id}`).set(newStatus);
                
                alert(`${id}: ${actionType === 'SIGN_IN' ? 'ขึ้นเวรสำเร็จ' : 'ลงเวรสำเร็จ'}!`);
                document.getElementById('firefighterID').value = '';

            } catch (error) {
                console.error("Firebase write error:", error);
                alert(`เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${error.message}`);
            }
        }

        // ฟังก์ชัน Realtime Listener สำหรับแสดง Log ล่าสุด (ไม่เปลี่ยนแปลง)
        function listenForLogs() {
            const logList = document.getElementById('dutyLog');
            
            database.ref(LOG_PATH).limitToLast(50).on('value', (snapshot) => {
                logList.innerHTML = '';
                const logs = snapshot.val();
                
                if (logs) {
                    const sortedKeys = Object.keys(logs).sort((a, b) => logs[b].timestamp - logs[a].timestamp);
                    
                    sortedKeys.forEach((key) => {
                        const log = logs[key];
                        const date = new Date(log.timestamp);
                        const timeString = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                        
                        const newLogItem = document.createElement('li');
                        const actionText = log.action === 'SIGN_IN' ? 'ขึ้นเวรสำเร็จ' : 'ลงเวรสำเร็จ';
                        const color = log.action === 'SIGN_IN' ? '#28a745' : '#dc3545';
                        
                        newLogItem.innerHTML = `[${timeString}] **${log.unit}** | รหัส **${log.id}**: <b style="color:${color}">${actionText}</b>`;
                        newLogItem.style.color = color;

                        logList.appendChild(newLogItem);
                    });
                } else {
                    logList.innerHTML = '<li>ยังไม่มีข้อมูลการปฏิบัติหน้าที่</li>';
                }
            }, (error) => {
                console.error("Firebase read error:", error);
                logList.innerHTML = `<li style="color: red;">เกิดข้อผิดพลาดในการดึงข้อมูล: ${error.message}</li>`;
            });
        }
    </script>
</body>
</html>

